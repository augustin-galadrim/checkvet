components: []
container:
  properties:
    html: "<html>\n  <head>\n    <meta charset=\"UTF-8\">\n    <style>\n      .audio-section {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 20px 0;\n        width: 100%;\n      }\n      .recording-controls {\n        display: flex;\n        justify-content: center;\n        align-items: center;\n      }\n      #recordingWidget-button-toggle {\n        width: 90px;\n        height: 90px;\n        border-radius: 50%;\n        border: none;\n        cursor: pointer;\n        background-color: #3974CB; \n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 38px; \n        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);\n        box-shadow: 0 4px 10px rgba(0,0,0,0.25);\n      }\n      #recordingWidget-button-toggle:hover {\n        background-color: #4B9AE9;\n        transform: scale(1.05);\n        box-shadow: 0 6px 12px rgba(0,0,0,0.3);\n      }\n      #recordingWidget-button-toggle.is-recording {\n        background-color: #f44336; /* Red for stop */\n        animation: pulse-animation 1.5s infinite;\n      }\n      #recordingWidget-button-toggle svg {\n        pointer-events: none;\n        transition: transform 0.3s ease-in-out;\n      }\n      @keyframes pulse-animation {\n        0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }\n        70% { box-shadow: 0 0 0 25px rgba(244, 67, 54, 0); }\n        100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }\n      }\n    </style>\n  </head>\n  <body>\n    <div class=\"audio-section\">\n      <div class=\"recording-controls\" id=\"recordingMode\">\n        <button id=\"recordingWidget-button-toggle\" title=\"Start Recording\">\n          <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\" fill=\"currentColor\" viewBox=\"0 0 16 16\">\n            <path d=\"M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z\"/>\n            <path d=\"M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z\"/>\n          </svg>\n        </button>\n      </div>\n    </div>\n\n    <script>\n      if (!window.__recording_widget_globals) {\n        window.__recording_widget_globals = true;\n\n        const logger = window.createLogger('RecordingWidget');\n        let recordingState = {\n          mediaRecorder: null,\n          recordedChunks: [],\n          audioBlob: null,\n          stream: null,\n          isRecording: false\n        };\n\n        const stopIconHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" fill=\"currentColor\" viewBox=\"0 0 16 16\"><path d=\"M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5z\"/></svg>`;\n        const micIconHTML = `<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"32\" height=\"32\" fill=\"currentColor\" viewBox=\"0 0 16 16\"><path d=\"M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z\"/><path d=\"M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z\"/></svg>`;\n\n        window.attachRecordingEvents = function() {\n          const recordButton = document.getElementById(\"recordingWidget-button-toggle\");\n\n          if (recordButton) {\n            const newRecordButton = recordButton.cloneNode(true);\n            recordButton.parentNode.replaceChild(newRecordButton, recordButton);\n\n            newRecordButton.addEventListener(\"click\", async (evt) => {\n              if (!recordingState.isRecording) {\n                try {\n                  recordingState.stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n\n                  const mimeTypes = [\n                    'audio/webm;codecs=opus', // Preferred for quality and compatibility\n                    'audio/mp4',             // Essential for Safari/iOS\n                    'audio/webm',            // Generic fallback\n                    'audio/ogg;codecs=opus'  // Alternative for Firefox\n                  ];\n                  let supportedMimeType = '';\n                  for (const type of mimeTypes) {\n                    if (MediaRecorder.isTypeSupported(type)) {\n                      supportedMimeType = type;\n                      break;\n                    }\n                  }\n\n                  if (!supportedMimeType) {\n                    logger.error(\"No supported MediaRecorder MIME type found on this browser.\");\n                    anvil.call(newRecordButton, 'show_error', \"Your browser does not support audio recording.\");\n                    // Clean up stream tracks\n                    if (recordingState.stream) {\n                      recordingState.stream.getTracks().forEach(track => track.stop());\n                      recordingState.stream = null;\n                    }\n                    return; // Abort if no supported type is found\n                  }\n\n                  logger.log(`Using supported MIME type: ${supportedMimeType}`);\n\n                  recordingState.mediaRecorder = new MediaRecorder(recordingState.stream, { mimeType: supportedMimeType });\n                  recordingState.recordedChunks = [];\n                  recordingState.mediaRecorder.ondataavailable = e => recordingState.recordedChunks.push(e.data);\n\n                  recordingState.mediaRecorder.onstop = () => {\n                    recordingState.audioBlob = new Blob(recordingState.recordedChunks, { type: supportedMimeType });\n                    logger.log('Recording finished, calling python `handle_js_recording_complete`.');\n                    anvil.call(newRecordButton, \"handle_js_recording_complete\", recordingState.audioBlob, supportedMimeType);\n                  };\n\n                  recordingState.mediaRecorder.start();\n                  recordingState.isRecording = true;\n\n                  newRecordButton.innerHTML = stopIconHTML;\n                  newRecordButton.classList.add(\"is-recording\");\n                  anvil.call(newRecordButton, 'start_recording');\n                  logger.log('Recording started.');\n\n                } catch (err) {\n                  logger.error(\"Microphone access error:\", err);\n                  anvil.call(newRecordButton, 'show_error', \"Microphone access denied.\");\n                  newRecordButton.innerHTML = micIconHTML;\n                  newRecordButton.classList.remove(\"is-recording\");\n                  recordingState.isRecording = false;\n                }\n              } else {\n                if (recordingState.mediaRecorder && recordingState.mediaRecorder.state !== \"inactive\") {\n                  recordingState.mediaRecorder.stop();\n                  recordingState.isRecording = false;\n\n                  if (recordingState.stream) {\n                    recordingState.stream.getTracks().forEach(track => track.stop());\n                    recordingState.stream = null;\n                  }\n\n                  newRecordButton.innerHTML = micIconHTML;\n                  newRecordButton.classList.remove(\"is-recording\");\n                  anvil.call(newRecordButton, 'stop_recording');\n                  logger.log('Recording stopped.');\n                }\n              }\n            });\n            logger.log('Event listener attached to record button.');\n          } else {\n            logger.warn('Could not attach listener to record button as it was not found.');\n          }\n        };\n      }\n      attachRecordingEvents();\n    </script>\n  </body>\n</html>"
  type: HtmlTemplate
custom_component: true
events:
- default_event: true
  name: recording_complete
  parameters:
  - {name: audio_blob}
is_package: true
properties: []
