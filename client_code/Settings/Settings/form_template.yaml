components:
- layout_properties: {slot: time_display_slot}
  name: time_display_1
  properties: {}
  type: form:Components.TimeDisplay
- layout_properties: {slot: default}
  name: header_nav_1
  properties: {active_tab: Settings}
  type: form:Components.HeaderNav
container:
  properties:
    html: |-
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="utf-8">
          <style>
            /* --- Existing Global Styles (Slightly adjusted for consistency) --- */
            * {
              box-sizing: border-box;
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
            }
            body {
              background-color: #f5f5f5;
              height: 100vh;
              overflow: hidden;
            }
            .container {
              display: flex;
              flex-direction: column;
              height: 100vh;
              max-width: 800px;
              margin: 0 auto;
              background-color: white;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .fixed-section {
              background: white;
              z-index: 10;
            }
            .actions-row {
              display: flex;
              justify-content: flex-end;
              align-items: center;
              padding: 15px 20px;
            }
            .time {
              color: #666;
              font-size: 14px;
            }
            .scrollable-content {
              flex: 1;
              overflow-y: auto;
              padding: 20px;
            }

            /* --- NEW: Improved Settings Layout Styles --- */
            .settings-form {
              background-color: white;
              border-radius: 8px;
            }
            .settings-section {
              background-color: #f9f9f9;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              padding: 20px;
              margin-bottom: 25px;
            }
            .section-title {
              font-size: 18px;
              font-weight: 600;
              color: #333;
              margin-top: 0;
              margin-bottom: 20px;
              border-bottom: 1px solid #e0e0e0;
              padding-bottom: 10px;
            }
            .form-row {
              display: flex;
              flex-wrap: wrap;
              gap: 20px;
            }
            .form-group {
              flex: 1 1 100%; /* Default to full width */
              margin-bottom: 15px;
            }
            .form-group.half-width {
              flex: 1 1 calc(50% - 10px); /* Two columns on larger screens */
              min-width: 250px; /* Prevent excessive shrinking */
            }
            .form-group label {
              display: block;
              margin-bottom: 8px;
              font-weight: 500;
              color: #333;
            }
            .form-group input[type="text"],
            .form-group input[type="email"],
            .form-group input[type="tel"] {
              width: 100%;
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 14px;
            }
            .form-group input[readonly] {
              background-color: #f0f0f0;
              cursor: not-allowed;
            }
            .structure-field-container {
              display: flex;
              align-items: center;
              gap: 10px;
            }
            #join-structure-btn {
              padding: 8px 16px;
              background-color: #007bff;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
              white-space: nowrap;
            }
            .button-group {
              display: flex;
              gap: 10px;
              margin-top: 20px;
              justify-content: flex-end;
            }
            .custom-button {
              padding: 12px 24px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 14px;
              text-align: center;
              transition: background-color 0.3s;
            }
            #submit-btn {
              background-color: #4CAF50;
              color: white;
            }
            #cancel-btn {
              background-color: #aaa;
              color: white;
            }
            .custom-structure-button {
              width: 100%;
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 14px;
              background-color: #fff;
              cursor: pointer;
              text-align: left;
            }

            /* --- Modal Styles --- */
            .modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
            .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; }
            .modal-close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
            /* This is the shared style for options in both modals */
            .structure-option { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0; cursor: pointer; background-color: #fff; }
            .structure-option.selected { background-color: #d0ebff; border-color: #66b0ff; }

            /* --- Join Code Modal Styles --- */
            #join-code-input.error { border-color: #f44336; }
            #join-code-error { color: #f44336; font-size: 12px; margin-top: 5px; display: none; }
            .logout-footer {
              padding: 20px; border-top: 1px solid #ddd; background-color: #f8f8f8; text-align: center; margin-top: 20px;
            }
            #logout-btn, #admin-btn {
              background-color: #f44336; color: white; border: none; border-radius: 4px; padding: 12px 24px; cursor: pointer; font-size: 14px; width: 100%;
            }
            #admin-btn {
              background-color: #007bff; margin-bottom: 10px; display: none; font-weight: bold; border: 2px solid #0056b3;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="fixed-section">
              <div anvil-slot="default"></div>
              <div class="actions-row">
                <div anvil-slot="time_display_slot"></div>
              </div>
            </div>
            <div class="scrollable-content">
              <div class="settings-form">
                <form id="vet-settings-form" onsubmit="return false;">

                  <!-- Section 1: Vet Information -->
                  <div class="settings-section">
                    <h2 class="section-title">Vet Information</h2>
                    <div class="form-row">
                      <div class="form-group half-width">
                        <label for="name">Name</label>
                        <input type="text" id="name" name="name_input" required>
                      </div>
                      <div class="form-group half-width">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone_input">
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="email">Email</label>
                      <input type="email" id="email" name="email_input" readonly>
                    </div>
                  </div>

                  <!-- Section 2: Organization -->
                  <div class="settings-section">
                    <h2 class="section-title">Organization</h2>
                    <div class="form-group">
                      <label for="structure-display">Structure</label>
                      <div class="structure-field-container">
                        <input type="text" id="structure-display" readonly>
                        <button type="button" id="join-structure-btn" style="display: none;">Join</button>
                      </div>
                    </div>
                    <!-- Supervisor Message - Initially hidden -->
                    <div id="supervisor-message" style="display: none; font-style: italic; color: #333; margin-top: 10px; padding: 10px; background-color: #e9f5ff; border-left: 4px solid #007bff; border-radius: 4px;">
                      You have the <strong>Supervisor</strong> role in your structure.
                    </div>
                    <!-- Join Code Field - Initially hidden -->
                    <div class="form-group" id="join-code-container" style="display: none; margin-top: 15px;">
                      <label for="join-code">Structure Join Code</label>
                      <input type="text" id="join-code" readonly>
                    </div>
                  </div>

                  <!-- Section 3: Preferences -->
                  <div class="settings-section">
                    <h2 class="section-title">Preferences</h2>
                    <div class="form-group">
                      <label for="favorite-language-button">Favorite Language</label>
                      <input type="hidden" id="favorite-language" name="favorite_language_input">
                      <button type="button" id="favorite-language-button" class="custom-structure-button">English</button>
                    </div>
                  </div>

                  <!-- Section 4: Tools -->
                  <div class="settings-section">
                    <h2 class="section-title">Tools</h2>
                    <button type="button" id="microphone-test-button" class="custom-structure-button">Test My Microphone</button>
                    <button type="button" id="show-install-guide-button" class="custom-structure-button" style="margin-top: 10px;">Show App Install Guide</button>
                  </div>

                  <!-- Main Action Buttons -->
                  <div class="button-group">
                    <div id="cancel-btn" class="custom-button">Cancel</div>
                    <div id="submit-btn" class="custom-button">Update Settings</div>
                  </div>
                </form>
              </div>
              <div class="logout-footer">
                <button id="admin-btn" class="custom-button">Administration</button>
                <button id="logout-btn" class="custom-button">Logout</button>
              </div>
            </div>
          </div>

          <!-- NEW MODAL for Joining a Structure -->
          <div id="join-structure-modal" class="modal">
            <div class="modal-content">
              <span id="join-modal-close" class="modal-close">×</span>
              <h3>Join a Structure</h3>
              <p>Enter the 6-digit join code provided by your structure's supervisor.</p>
              <div class="form-group">
                <label for="join-code-input">Join Code</label>
                <input type="text" id="join-code-input" maxlength="6">
                <div id="join-code-error">This code doesn't exist.</div>
              </div>
              <div class="button-group">
                <button id="submit-join-code-btn" class="custom-button btn-primary" style="background-color: #007bff;">Join Structure</button>
              </div>
            </div>
          </div>

          <!-- Modals (Language Only) -->
          <div id="favorite-language-modal" class="modal">
            <div class="modal-content">
              <span id="favorite-language-modal-close" class="modal-close">×</span>
              <h3>Select Favorite Language</h3>
              <div id="favorite-language-options"></div>
            </div>
          </div>

          <script>
            // Function to show/hide admin button
            window.showAdminButton = function(isAdmin) {
              const adminBtn = document.getElementById("admin-btn");
              if (adminBtn) adminBtn.style.display = isAdmin ? "block" : "none";
            };

            // Function to handle supervisor view
            window.updateSupervisorView = function(isSupervisor, joinCode) {
              const supervisorMessage = document.getElementById("supervisor-message");
              const joinCodeContainer = document.getElementById("join-code-container");
              const joinCodeInput = document.getElementById("join-code");

              if (supervisorMessage) supervisorMessage.style.display = isSupervisor ? 'block' : 'none';

              if (joinCodeContainer && joinCodeInput) {
                if (isSupervisor && joinCode) {
                  joinCodeContainer.style.display = 'block';
                  joinCodeInput.value = joinCode;
                } else {
                  joinCodeContainer.style.display = 'none';
                  joinCodeInput.value = '';
                }
              }
            };

            // NEW: Function to show/hide the "Join" button
            window.toggleJoinButton = function(show) {
              const joinButton = document.getElementById("join-structure-btn");
              if(joinButton) joinButton.style.display = show ? 'inline-block' : 'none';
            };

            // ---------------------------------------
            // 1) Exécuter une seule fois par session
            // ---------------------------------------
            if (!window.__my_vet_settings_globals) {
              window.__my_vet_settings_globals = true;

              // Get/set functions
              window.getValueById = (id) => document.getElementById(id)?.value || "";
              window.setValueById = (id, value) => { if(document.getElementById(id)) document.getElementById(id).value = value; };
              window.setButtonTextById = (id, text) => { if(document.getElementById(id)) document.getElementById(id).textContent = text; };

              // Remplir le modal de langue préférée avec des options.
              window.populateFavoriteLanguageModal = function(options, current) {
                const optionsContainer = document.getElementById("favorite-language-options");
                optionsContainer.innerHTML = "";
                options.forEach(opt => {
                  const optionElem = document.createElement("div");
                  optionElem.classList.add("structure-option");
                  optionElem.textContent = opt.display;
                  if (current && opt.value === current) optionElem.classList.add("selected");
                  optionElem.addEventListener("click", function(event) {
                    document.getElementById("favorite-language").value = opt.value;
                    setButtonTextById("favorite-language-button", opt.display);
                    window.closeFavoriteLanguageModal();
                  });
                  optionsContainer.appendChild(optionElem);
                });
              };

              // Modal control functions
              window.openFavoriteLanguageModal = () => document.getElementById("favorite-language-modal").style.display = "block";
              window.closeFavoriteLanguageModal = () => document.getElementById("favorite-language-modal").style.display = "none";
              window.openJoinModal = () => document.getElementById("join-structure-modal").style.display = "block";
              window.closeJoinModal = () => document.getElementById("join-structure-modal").style.display = "none";

              // NEW: Join code error functions
              window.showJoinCodeError = function(message) {
                const errorDiv = document.getElementById('join-code-error');
                const input = document.getElementById('join-code-input');
                if(errorDiv) {
                  errorDiv.textContent = message || "This code doesn't exist.";
                  errorDiv.style.display = 'block';
                }
                if(input) input.classList.add('error');
              };
              window.hideJoinCodeError = function() {
                document.getElementById('join-code-error').style.display = 'none';
                document.getElementById('join-code-input').classList.remove('error');
              };

              // Attacher les écouteurs d'événements
              window.__attachVetSettingsEvents = function() {
                const vetSettingsForm = document.getElementById('vet-settings-form');

                // Main buttons
                document.getElementById('submit-btn').addEventListener('click', () => anvil.call(vetSettingsForm, 'submit_click'));
                document.getElementById('cancel-btn').addEventListener('click', () => anvil.call(vetSettingsForm, 'cancel_click'));

                // Language modal buttons
                document.getElementById("favorite-language-button").addEventListener('click', window.openFavoriteLanguageModal);
                document.getElementById("favorite-language-modal-close").addEventListener('click', window.closeFavoriteLanguageModal);

                // NEW: Join modal buttons
                document.getElementById("join-structure-btn").addEventListener('click', window.openJoinModal);
                document.getElementById("join-modal-close").addEventListener('click', window.closeJoinModal);
                document.getElementById('submit-join-code-btn').addEventListener('click', () => {
                  hideJoinCodeError();
                  const code = getValueById('join-code-input');
                  if (!code || code.trim().length !== 6) {
                    showJoinCodeError("Please enter a valid 6-character code.");
                    return;
                  }
                  anvil.call(vetSettingsForm, 'attempt_to_join_structure', code).then(result => {
                    if (result && !result.success) {
                      showJoinCodeError(result.message);
                    } else {
                      closeJoinModal(); // Success is handled by Python reloading the form
                    }
                  });
                });

                // Other buttons
                document.getElementById("microphone-test-button").addEventListener('click', () => anvil.call(vetSettingsForm, 'openMicrophoneTest'));
                document.getElementById("show-install-guide-button").addEventListener('click', () => anvil.call(vetSettingsForm, 'show_install_guide_click'));
                document.getElementById("logout-btn").addEventListener('click', () => anvil.call(vetSettingsForm, 'logout_click'));
                document.getElementById("admin-btn").addEventListener('click', () => anvil.call(vetSettingsForm, 'openAdmin'));
              };
            }

            // Attacher les écouteurs dès que le DOM est prêt
            window.__attachVetSettingsEvents();

            // Session handler
            if (!window.__session_handlers_initialized) {
              window.__session_handlers_initialized = true;
              window.setupSessionHandlers = function() {
                document.addEventListener('visibilitychange', () => {
                  if (document.visibilityState === 'visible') anvil.call(document.getElementById('vet-settings-form'), 'refresh_session_relay');
                });
                window.addEventListener('online', () => anvil.call(document.getElementById('vet-settings-form'), 'refresh_session_relay'));
              };
              window.setupSessionHandlers();
            }
          </script>
        </body>
      </html>
  type: HtmlTemplate
is_package: true
