components: []
container:
  properties:
    html: "<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\" />\n  <title>Gestion des Templates/IA</title>\n  <style>\n    /* ---------------------------\n       Global & Layout Styles\n       --------------------------- */\n    * {\n      box-sizing: border-box;\n      font-family: Arial, sans-serif;\n      margin: 0;\n      padding: 0;\n    }\n    body {\n      background-color: #f5f5f5;\n      height: 100vh;\n      overflow: hidden;\n    }\n    .container {\n      display: flex;\n      flex-direction: column;\n      height: 100vh;\n      max-width: 800px;\n      margin: 0 auto;\n      background-color: white;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n      position: relative;\n    }\n    .fixed-section {\n      background: white;\n      z-index: 10;\n    }\n    .nav-tabs {\n      display: flex;\n      width: 100%;\n      border-bottom: 1px solid #ddd;\n    }\n    .nav-tab {\n      flex: 1;\n      padding: 8px 16px;\n      cursor: pointer;\n      border: 1px solid #ccc;\n      border-bottom: none;\n      background: #f8f8f8;\n      font-size: 14px;\n      position: relative;\n      margin-right: -1px;\n      text-align: center;\n    }\n    .nav-tab.active {\n      background: #e5e5e5;\n      border-top: 1px solid #999;\n      border-left: 1px solid #999;\n      border-right: 1px solid #999;\n      border-bottom: 1px solid #e5e5e5;\n      margin-bottom: -1px;\n    }\n    .actions-row {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 15px 20px;\n    }\n    .left-section {\n      display: flex;\n      align-items: center;\n      flex: 1;\n      justify-content: space-between;\n    }\n    /* Container for the two buttons */\n    .buttons-container {\n      display: flex;\n      gap: 10px;\n      align-items: center;\n    }\n    .create-button {\n      padding: 8px 16px;\n      background: #fff;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      gap: 5px;\n    }\n    .create-button:hover {\n      background: #f5f5f5;\n    }\n    /* Style for the new personalize button */\n    .personalize-button {\n      padding: 8px 16px;\n      background: #fff;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      cursor: pointer;\n    }\n    .personalize-button:hover {\n      background: #f5f5f5;\n    }\n    .time {\n      color: #666;\n      font-size: 14px;\n    }\n    .search-bar {\n      display: block;\n      width: calc(100% - 40px);\n      padding: 8px;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      margin: 0 20px 15px 20px;\n    }\n    .scrollable-content {\n      flex: 1;\n      overflow-y: auto;\n      padding: 20px;\n    }\n    /* ---------------------------\n       Template List Styles\n       --------------------------- */\n    .template-list {\n      list-style: none;\n      margin: 0;\n      padding: 0;\n    }\n    .template-item {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 12px;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      margin-bottom: 8px;\n      background: white;\n    }\n    .template-name {\n      flex-grow: 1;\n      margin-right: 10px;\n    }\n    .template-actions {\n      display: flex;\n      gap: 10px;\n      align-items: center;\n    }\n    .star-icon {\n      cursor: pointer;\n      font-size: 20px;\n    }\n    .edit-button {\n      padding: 4px 8px;\n      background: #f0f0f0;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      cursor: pointer;\n    }\n    .delete-icon {\n      color: #666;\n      cursor: pointer;\n    }\n    /* ---------------------------\n       Custom Scrollbar\n       --------------------------- */\n    .scrollable-content::-webkit-scrollbar {\n      width: 8px;\n    }\n    .scrollable-content::-webkit-scrollbar-track {\n      background: #f1f1f1;\n    }\n    .scrollable-content::-webkit-scrollbar-thumb {\n      background: #888;\n      border-radius: 4px;\n    }\n    .scrollable-content::-webkit-scrollbar-thumb:hover {\n      background: #555;\n    }\n    /* ---------------------------\n       Modal Styles\n       --------------------------- */\n    .modal-backdrop {\n      display: none; /* Toggled by JS */\n      position: fixed;\n      top: 0;\n      left: 0;\n      z-index: 999;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n    }\n    .modal-container {\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: #fff;\n      width: 90%;\n      max-width: 400px;\n      padding: 20px;\n      border-radius: 6px;\n      box-shadow: 0 2px 10px rgba(0,0,0,0.3);\n    }\n    .modal-header {\n      font-weight: bold;\n      margin-bottom: 10px;\n    }\n    .modal-body {\n      margin-bottom: 15px;\n    }\n    .modal-body p {\n      margin-bottom: 10px;\n    }\n    .modal-body label {\n      display: inline-block;\n      margin-bottom: 6px;\n      font-weight: bold;\n    }\n    .modal-footer {\n      display: flex;\n      justify-content: flex-end;\n      gap: 10px;\n    }\n    .button {\n      padding: 6px 12px;\n      border: 1px solid #ddd;\n      border-radius: 4px;\n      background: #f5f5f5;\n      cursor: pointer;\n    }\n    .button:hover {\n      background: #e0e0e0;\n    }\n    .banner-message {\n      position: absolute;\n      top: 10px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: #fffae6;\n      border: 1px solid #f0e68c;\n      padding: 10px 20px;\n      border-radius: 4px;\n      font-weight: bold;\n      color: #666;\n      z-index: 1000;\n      opacity: 0.95;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <!-- Ce conteneur de banni√®re affichera des messages temporaires -->\n    <div id=\"bannerContainer\"></div>\n\n    <!-- Section fixe : Navigation & Actions -->\n    <div class=\"fixed-section\">\n      <div class=\"nav-tabs\">\n        <button class=\"nav-tab\" data-tab=\"Production\">Production</button>\n        <button class=\"nav-tab active\" data-tab=\"Mod√®les/IA\">Mod√®les/IA</button>\n        <button class=\"nav-tab\" data-tab=\"Archives\">Archives</button>\n        <button class=\"nav-tab\" data-tab=\"Param√®tres\">Param√®tres</button>\n      </div>\n      <div class=\"actions-row\">\n        <div class=\"left-section\">\n          <div class=\"buttons-container\">\n            <button class=\"create-button\" id=\"createBtn\">+ Cr√©er</button>\n            <button class=\"personalize-button\" id=\"personalizeBtn\">Personaliser votre IA</button>\n          </div>\n          <div class=\"time\">--:--</div>\n        </div>\n      </div>\n      <input type=\"text\" class=\"search-bar\" placeholder=\"Rechercher\">\n    </div>\n    <!-- Liste d√©filante des templates -->\n    <div class=\"scrollable-content\">\n      <ul class=\"template-list\" id=\"templateList\">\n        <!-- Inject√© dynamiquement par JS -->\n      </ul>\n    </div>\n  </div>\n\n  <!-- Fond de modal pour le t√©l√©chargement et la transformation du PDF -->\n  <div class=\"modal-backdrop\" id=\"pdfModalBackdrop\">\n    <div class=\"modal-container\">\n      <div id=\"modalContent\">\n        <!-- Contenu dynamique du modal -->\n      </div>\n    </div>\n  </div>\n\n  <script>\n    // ------------------------------------------------------------\n    // Utilitaire : Afficher un message de banni√®re temporaire\n    // ------------------------------------------------------------\n    function showBanner(message) {\n      const bannerContainer = document.getElementById(\"bannerContainer\");\n      if (!bannerContainer) return;\n      const banner = document.createElement(\"div\");\n      banner.className = \"banner-message\";\n      banner.textContent = message;\n      bannerContainer.appendChild(banner);\n      setTimeout(() => {\n        bannerContainer.removeChild(banner);\n      }, 3000);\n    }\n\n    // ------------------------------------------------------------\n    // 1) D√©clarations globales & fonction populateTemplates\n    // ------------------------------------------------------------\n    if (!window.__templates_globals) {\n      window.__templates_globals = true;\n\n      window.populateTemplates = function(templates) {\n        /*\n          Format attendu pour chaque template :\n          {\n            \"id\": <identifiant unique>,\n            \"template_name\": \"Un Nom\",\n            \"owner\": ...,\n            \"prompt\": ...,\n            \"human_readable\": ...,\n            \"priority\": 0   // 0, 1 ou 2\n          }\n        */\n        const list = document.getElementById(\"templateList\");\n        if (!list) {\n          console.log(\"populateTemplates: #templateList introuvable\");\n          return;\n        }\n        list.innerHTML = \"\";\n        templates.forEach(tpl => {\n          const li = document.createElement(\"li\");\n          li.className = \"template-item\";\n          li.dataset.id = tpl.id;\n          li.dataset.priority = tpl.priority || \"0\";\n          li.dataset.name = tpl.template_name;  // stockage de template_name\n\n          // √âl√©ment affichant le nom du template\n          const spanName = document.createElement(\"span\");\n          spanName.className = \"template-name\";\n          spanName.textContent = tpl.template_name || \"Template sans nom\";\n\n          // Conteneur des actions\n          const actionsDiv = document.createElement(\"div\");\n          actionsDiv.className = \"template-actions\";\n\n          // Ic√¥ne d'√©toile ‚Äì sa couleur refl√®te la priorit√© actuelle :\n          // 0 : gris, 1 : jaune, 2 : vert.\n          const star = document.createElement(\"span\");\n          star.className = \"star-icon\";\n          const prio = parseInt(tpl.priority) || 0;\n          if (prio === 2) {\n            star.style.color = \"green\";\n          } else if (prio === 1) {\n            star.style.color = \"yellow\";\n          } else {\n            star.style.color = \"#ccc\";\n          }\n          star.textContent = \"‚òÖ\";\n          star.addEventListener(\"click\", (event) => {\n            updateTemplatePriority(event, li);\n          });\n\n          // Bouton Modifier ‚Äì affiche une banni√®re lorsqu'il est cliqu√©.\n          const editBtn = document.createElement(\"button\");\n          editBtn.className = \"edit-button\";\n          editBtn.textContent = \"Modifier\";\n          editBtn.addEventListener(\"click\", (event) => {\n            showBanner(\"fonctionalit√© en cours de d√©veloppement par les √©quipes Checkvet\");\n          });\n\n          // Ic√¥ne de suppression ‚Äì affiche une banni√®re lorsqu'elle est cliqu√©e.\n          const delIcon = document.createElement(\"span\");\n          delIcon.className = \"delete-icon\";\n          delIcon.textContent = \"üóë\";\n          delIcon.addEventListener(\"click\", (event) => {\n            showBanner(\"fonctionalit√© en cours de d√©veloppement par les √©quipes Checkvet\");\n          });\n\n          actionsDiv.appendChild(star);\n          actionsDiv.appendChild(editBtn);\n          actionsDiv.appendChild(delIcon);\n\n          li.appendChild(spanName);\n          li.appendChild(actionsDiv);\n          list.appendChild(li);\n        });\n      };\n    }\n\n    // ------------------------------------------------------------\n    // 2) Mise √† jour de la priorit√© d'un template (logique du clic sur l'√©toile)\n    // ------------------------------------------------------------\n    function updateTemplatePriority(event, tplElement) {\n      const currentPriority = parseInt(tplElement.dataset.priority) || 0;\n      let newPriority = (currentPriority + 1) % 3; // Cycle : 0 ‚Üí 1 ‚Üí 2 ‚Üí 0\n\n      // Si promotion au jaune (priorit√© 1), s'assurer qu'il y a au maximum 2 favoris jaunes\n      if (newPriority === 1) {\n        let yellowCount = 0;\n        document.querySelectorAll('.template-item').forEach(item => {\n          if (item !== tplElement && item.dataset.priority === \"1\") {\n            yellowCount++;\n          }\n        });\n        if (yellowCount >= 2) {\n          alert(\"Nombre maximal de favoris jaunes atteint. Veuillez r√©trograder un template avant de promouvoir celui-ci en jaune.\");\n          return;\n        }\n      }\n\n      // Si promotion au vert (priorit√© 2), r√©trograder automatiquement tout autre template vert.\n      if (newPriority === 2) {\n        document.querySelectorAll('.template-item').forEach(item => {\n          if (item !== tplElement && item.dataset.priority === \"2\") {\n            item.dataset.priority = \"0\";\n            const starOther = item.querySelector('.star-icon');\n            if (starOther) starOther.style.color = \"#ccc\";\n            // Mettre √† jour l'autre template sur le serveur en utilisant son template_name.\n            anvil.call(event.target, 'set_priority', item.dataset.name, 0);\n          }\n        });\n      }\n\n      // Mettre √† jour l'√©tat visuel du template cliqu√©\n      tplElement.dataset.priority = newPriority;\n      const star = tplElement.querySelector('.star-icon');\n      if (newPriority === 0) {\n        star.style.color = \"#ccc\";\n      } else if (newPriority === 1) {\n        star.style.color = \"yellow\";\n      } else if (newPriority === 2) {\n        star.style.color = \"green\";\n      }\n\n      // Informer le serveur (via la m√©thode Python c√¥t√© front) du changement de priorit√©.\n      anvil.call(event.target, 'set_priority', tplElement.dataset.name, newPriority);\n    }\n\n    // ------------------------------------------------------------\n    // 3) Attacher les √©couteurs d'√©v√©nements pour la navigation, les boutons et la barre de recherche\n    // ------------------------------------------------------------\n    (function attachTemplatesEvents() {\n      console.log(\"TemplatesPage : Attachement des √©couteurs d'√©v√©nements...\");\n\n      // Onglets de navigation\n      const tabs = document.querySelectorAll('.nav-tab');\n      tabs.forEach(tab => {\n        tab.addEventListener('click', (event) => {\n          const currentActive = document.querySelector('.nav-tab.active');\n          if (currentActive) currentActive.classList.remove('active');\n          tab.classList.add('active');\n\n          const tabText = tab.getAttribute(\"data-tab\");\n          if (tabText === 'Production') {\n            anvil.call(event.target, 'open_production_form');\n          } else if (tabText === 'Archives') {\n            anvil.call(event.target, 'open_archives_form');\n          } else if (tabText === 'Param√®tres') {\n            anvil.call(event.target, 'open_settings_form');\n          }\n          // Pour l'onglet Mod√®les/IA, nous sommes d√©j√† sur cette page.\n        });\n      });\n\n      // Bouton Cr√©er ‚Äì affiche le modal PDF\n      const createBtn = document.getElementById('createBtn');\n      if (createBtn) {\n        createBtn.replaceWith(createBtn.cloneNode(true));\n        const newCreateBtn = document.getElementById('createBtn');\n        newCreateBtn.addEventListener('click', (event) => {\n          anvil.call(event.target, 'show_pdf_modal');\n        });\n      }\n\n      // Bouton Personaliser votre IA ‚Äì affiche une banni√®re lorsqu'il est cliqu√©\n      const personalizeBtn = document.getElementById('personalizeBtn');\n      if (personalizeBtn) {\n        personalizeBtn.replaceWith(personalizeBtn.cloneNode(true));\n        const newPersonalizeBtn = document.getElementById('personalizeBtn');\n        newPersonalizeBtn.addEventListener('click', (event) => {\n          showBanner(\"fonctionalit√© en cours de d√©veloppement par les √©quipes Checkvet\");\n        });\n      }\n\n      // ------------------------------------------------------------------------\n      // Gestion de la barre de recherche pour les templates\n      // ------------------------------------------------------------------------\n      const searchInput = document.querySelector('.search-bar');\n      if (searchInput) {\n        searchInput.addEventListener('input', function(event) {\n          const query = event.target.value;\n          anvil.call(event.target, 'search_templates_client', query);\n        });\n      }\n\n      console.log(\"TemplatesPage : √âcouteurs d'√©v√©nements attach√©s.\");\n    })();\n\n    // ------------------------------------------------------------\n    // 4) Affichage de l'heure\n    // ------------------------------------------------------------\n    function updateTime() {\n      const now = new Date();\n      const hrs = now.getHours().toString().padStart(2, '0');\n      const mins = now.getMinutes().toString().padStart(2, '0');\n      document.querySelector('.time').textContent = `${hrs}h${mins}`;\n    }\n    updateTime();\n    setInterval(updateTime, 60000);\n\n    // ------------------------------------------------------------\n    // 5) Logique du modal pour la transformation de PDF en template\n    // ------------------------------------------------------------\n    window.openPdfModal = function() {\n      const backdrop = document.getElementById(\"pdfModalBackdrop\");\n      if (!backdrop) return;\n      backdrop.style.display = \"block\";\n\n      const modalContent = document.getElementById(\"modalContent\");\n      if (!modalContent) return;\n\n      modalContent.innerHTML = `\n        <div class=\"modal-header\">Bienvenue dans la personnalisation de templates</div>\n        <div class=\"modal-body\">\n          <p>Veuillez s√©lectionner un document PDF :</p>\n          <input type=\"file\" id=\"pdfFileInput\" accept=\"application/pdf\" />\n          <br/><br/>\n          <label for=\"templateNameInput\">Nom du template :</label><br/>\n          <input type=\"text\" id=\"templateNameInput\" placeholder=\"Ex : Mon nouveau template\" style=\"width:100%;\" />\n          <br/><br/>\n        </div>\n        <div class=\"modal-footer\">\n          <button class=\"button\" id=\"transformBtn\">Transformer en template</button>\n          <button class=\"button\" id=\"cancelBtn\">Annuler</button>\n        </div>\n      `;\n\n      const cancelBtn = document.getElementById(\"cancelBtn\");\n      cancelBtn.addEventListener(\"click\", () => {\n        backdrop.style.display = \"none\";\n      });\n\n      const transformBtn = document.getElementById(\"transformBtn\");\n      transformBtn.addEventListener(\"click\", async (event) => {\n        const fileInput = document.getElementById(\"pdfFileInput\");\n        const templateNameInput = document.getElementById(\"templateNameInput\");\n        if (!fileInput.files.length) {\n          alert(\"Veuillez s√©lectionner un fichier PDF d'abord.\");\n          return;\n        }\n        if (!templateNameInput.value.trim()) {\n          alert(\"Veuillez saisir un nom de template.\");\n          return;\n        }\n        const selectedFile = fileInput.files[0];\n        try {\n          const base64Pdf = await fileToBase64(selectedFile);\n          anvil.call(event.target, 'transform_pdf_to_template', base64Pdf, templateNameInput.value.trim());\n        } catch (err) {\n          alert(\"Erreur lors de la conversion du PDF : \" + err);\n        }\n      });\n    };\n\n    // Appel√© depuis Python pour afficher une banni√®re de succ√®s apr√®s transformation\n    window.showSuccessBanner = function() {\n      const modalContent = document.getElementById(\"modalContent\");\n      if (!modalContent) return;\n\n      modalContent.innerHTML = `\n        <div class=\"banner-message\">Bravo, vous avez un nouveau template !</div>\n        <div class=\"modal-footer\">\n          <button class=\"button\" id=\"closeSuccessBtn\">Fermer</button>\n        </div>\n      `;\n\n      const closeBtn = document.getElementById(\"closeSuccessBtn\");\n      closeBtn.addEventListener(\"click\", () => {\n        document.getElementById(\"pdfModalBackdrop\").style.display = \"none\";\n      });\n    };\n\n    // Utilitaire : Convertir un fichier en Base64\n    function fileToBase64(file) {\n      return new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onload = () => {\n          // Extraire uniquement la cha√Æne Base64 (apr√®s \"base64,\")\n          const base64Str = reader.result.split(\"base64,\")[1];\n          resolve(base64Str);\n        };\n        reader.onerror = (error) => reject(error);\n        reader.readAsDataURL(file);\n      });\n    }\n  </script>\n<!-- Add this simple script to your forms -->\n  <script>\n    // Initialize only once\n    if (!window.__session_handlers_initialized) {\n      window.__session_handlers_initialized = true;\n      \n      // Session handler setup\n      window.setupSessionHandlers = function() {\n        // Tab visibility change\n        document.addEventListener('visibilitychange', function() {\n          if (document.visibilityState === 'visible') {\n            anvil.call(document.body, 'refresh_session_relay');\n          }\n        });\n        \n        // Online status change\n        window.addEventListener('online', function() {\n          anvil.call(document.body, 'refresh_session_relay');\n        });\n      };\n    }\n  </script>\n</body>\n</html>\n"
  type: HtmlTemplate
is_package: true
